@model Cinema.ViewModels.Cinemas.CinemaDetailsViewModel

@{
    ViewData["Title"] = "Owner dashboard";
    var currentDate = DateTime.Now;
    string month = currentDate.Date.ToString("MMMM");
    int day = currentDate.Day;
}
<link href="~/css/manageStyle.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/cardStyle.css" />
<link href="~/css/ratingmodal.css" rel="stylesheet" />
<div class="app-content">
    <div class="products-area-wrapper gridView m-0 justify-content-center details">
        <div class="cinema-row details-card mb-3">
            <div class="cinema-cell image details-photo-pic">
                <a class="d-flex align-items-center cinema-link flex-column">
                    <img src="~/client-images/Cinemas/@Model.ImageUrl" alt="cinema-logo">
                    <span>@Model.Name</span>
                </a>
            </div>
            <div class="cinema-cell status-cell">
                <span class="cell-label">Status:</span>
                <span class="status">@Model.Status</span>
            </div>
            <div class="cinema-cell description">
                <span class="cell-label">Description:</span>
                <span class="cinema-description">
                    @Model.Description
                </span>
            </div>
            <div class="cinema-cell sales"><span class="cell-label">Founded on:</span>@Model.FoundedOn</div>
            <div class="cinema-cell description">
                <span class="cell-label">Rows:</span>
                <span>@Model.SeatRows</span>
            </div>
            <div class="cinema-cell description">
                <span class="cell-label">Columns:</span>
                <span>@Model.SeatCols</span>
            </div>
        </div>
        <div class="cinema-cell stock">
            <button id="edit" class="action-button active crud-button open-popup-btn">Edit</button>
            <button id="delete" class="action-button active crud-button open-popup-btn">Delete</button>
            <button id="preview-sectors" class="action-button active crud-button open-popup-btn">Preview sector layout</button>
        </div>
    </div>
    @if (Model.ApprovalStatus == ApprovalStatus.Approved)
    {
        <div class="app-content-actions">
            <input id="search-bar" class="search-bar" placeholder="Search..." type="text">
            <div class="app-content-actions-wrapper">
                <button class="action-button list active" title="List View">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>
                </button>
                <button class="action-button grid" title="Grid View">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid"><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></svg>
                </button>
            </div>
        </div>
        <div class="products-area-wrapper movies-wrapper tableView">
            <div class="products-header">
                <div class="cinema-cell image">
                    Movie
                    <button class="sort-button" id="name-sort-desc" title="Sort descending">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="sort-button" id="name-sort" title="Sort ascending">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                <div class="cinema-cell status-cell">
                    Genre
                    <button class="sort-button" id="genre-sort-desc" title="Sort descending">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="sort-button" id="genre-sort" title="Sort ascending">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                <div class="cinema-cell sales">
                    Average user rating
                    <button class="sort-button" id="rating-sort-desc" title="Sort descending">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="sort-button" id="rating-sort" title="Sort ascending">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                <div class="cinema-cell stock">
                    Ratings count
                    <button class="sort-button" id="ratingcount-sort-desc" title="Sort descending">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="sort-button" id="ratingcount-sort" title="Sort ascending">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
            <div class="movies-container" id="results-container">
            </div>
        </div>
    }
    else
    {
        <div class="message-container mt-5 text-white text-center">
            <h4>There are no movies here</h4>
            @if (Model.ApprovalStatus == ApprovalStatus.PendingApproval)
            {
                <h5>You must wait for your cinema to be approved by an administrator!</h5>
            }
            else
            {
                <h5>Your cinema was denied approval!</h5>
            }
        </div>
    }
</div>
<div class="rating-container">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="add-review-header" class="edit-modal">
        <button class="close-btn" aria-label="close" title="Close">x</button>
        <div id="review-form-container">
        </div>
    </div>
    <div class="modal-overlay"></div>
</div>
<script>
    window.onload = function () {
        getItems('Owners', 'SearchMoviesByCinema', "", '@Model.Id');
    };
    var search = document.getElementById("search-bar");
    var activeSort = document.querySelector('.sort-button.selected');
    if (search) {
        let timeout = null;
        search.addEventListener("keyup", function () {
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                getItems('Movies', 'SearchAndFilterMovies', search.value, '', '', (activeSort ? activeSort.id : null));
            }, 300);
        });
    }

    document.querySelectorAll(".sort-button").forEach(i => i.addEventListener('click', function () {
        var alreadyActive = document.querySelector('.sort-button.selected');
        if (alreadyActive) {
            alreadyActive.classList.remove("selected");
        }
        i.classList.add("selected");
        getItems('Movies', 'SearchAndFilterMovies', (search ? search.value : null), '', '', i.id);
    }));

    var modalContainer = document.getElementById('review-form-container');
    var editButton = document.getElementById("edit");
    editButton.addEventListener("click", function () {
        modalContainer.innerHTML = "";
        getUDpartial('Owners', 'EditCinema', '@Model.Id');
    });

    var deleteButton = document.getElementById("delete");
    deleteButton.addEventListener("click", function () {
        modalContainer.innerHTML = "";
        getUDpartial('Owners', 'DeleteCinema', '@Model.Id');
    });

    var previewButton = document.getElementById("preview-sectors");
    previewButton.addEventListener("click", function () {
        modalContainer.innerHTML = "";
        $.ajax({
            type: "GET",
            url: `/Owners/GenerateCustomPagePreview`,
            data: { userEmail: '@User.Identity.Name', cinemaId: '@Model.Id' },
            success: function (response) {
                //$("#review-form-container").html(response);
                location.href = 'https://localhost:44305/Owners/GenerateCustomPagePreview?userEmail=@User.Identity.Name&cinemaId=@Model.Id'
            },
            failure: function (response) {
                alert(response.responseText);
            },
            error: function (response) {
                alert(response.responseText);
            }
        });
    });
</script>
<script src="~/js/ownerdashboard.js"></script>
<script src="~/js/rating-modal.js"></script>
